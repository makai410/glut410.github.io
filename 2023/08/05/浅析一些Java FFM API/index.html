<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>æµ…æä¸€ä¸‹Java FFM API(Project Panama) - makai410</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>
    <body
        data-color-scheme="dark"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/makai410" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/Hotspot/">Hotspot</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>August</span>
            <span>5,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">æµ…æä¸€ä¸‹Java FFM API(Project Panama)</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><strong>è¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯è®²å¦‚ä½•ä½¿ç”¨Java FFM APIï¼Œè€Œæ˜¯æµ…è°ˆå…¶èƒŒåçš„å®ç°åŸç†ã€‚</strong></p>
<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2>
<p>å‰ä¸ä¹…ï¼ŒOpenJDKå®£å¸ƒäº†<code>Java Foreign Function &amp; Memory API</code>å°†åœ¨JDK 22é€€å‡ºé¢„è§ˆï¼Œè¿™æ„å‘³ç€åœ¨JDK 22åï¼ŒFFM APIä¸ä¼šæœ‰é‡å¤§æ”¹åŠ¨ã€‚å€Ÿæ­¤æœºä¼šï¼Œæˆ‘æƒ³å¯ä»¥å¥½å¥½èŠèŠFFM APIæ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<h2 id="ffm-apiä»‹ç»"><a class="markdownIt-Anchor" href="#ffm-apiä»‹ç»"></a> FFM APIä»‹ç»</h2>
<p>FFM APIç”±ä¸¤å¤§éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯<code>Foreign Function Interface</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>Memory API</code>ã€‚å‰è€…æ˜¯å¤–éƒ¨å‡½æ•°æ¥å£ï¼Œç®€ç§°FFIï¼Œç”¨å®ƒæ¥å®ç°Javaä»£ç å’Œå¤–éƒ¨ä»£ç ä¹‹é—´ç›¸äº’æ“ä½œï¼›åè€…æ˜¯å†…å­˜æ¥å£ï¼Œç”¨äº<strong>å®‰å…¨åœ°</strong>ç®¡ç†å †å¤–å†…å­˜ã€‚</p>
<h2 id="memory-api"><a class="markdownIt-Anchor" href="#memory-api"></a> Memory API</h2>
<p>ä¸ºäº†æ–¹ä¾¿åˆ‡å…¥ï¼Œæˆ‘è¿™é‡Œå†™äº†ä¸€ä¸ªå¾ˆç®€å•çš„Demoï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">allocDemo</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Arena</span> <span class="variable">arena</span> <span class="operator">=</span> Arena.ofConfined()) &#123;</span><br><span class="line">        <span class="type">MemorySegment</span> <span class="variable">cString</span> <span class="operator">=</span> arena.allocateUtf8String(<span class="string">&quot;Panama&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jString</span> <span class="operator">=</span> cString.getUtf8String(<span class="number">0l</span>);</span><br><span class="line">        System.out.println(jString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œåœ¨å †å¤–å¼€è¾Ÿäº†ä¸€æ®µå†…å­˜æ¥å­˜æ”¾å­—ç¬¦ä¸²<code>Panama</code>ï¼Œæ¥ä¸‹æ¥copyåˆ°JVMæ ˆä¸Šï¼Œæœ€åè¾“å‡ºã€‚</li>
<li>ç®€å•ä»‹ç»ä¸‹ï¼Œ<code>MemorySegment</code>ç”¨äºè¡¨ç¤ºä¸€æ®µå†…å­˜ç‰‡æ®µï¼ˆæ—¢å¯ä»¥æ˜¯å †å†…ä¹Ÿå¯ä»¥æ˜¯å †å¤–ï¼‰ï¼Œ<code>Arena</code>åˆ’å®šäº†ä¸€ä¸ªä½œç”¨åŸŸï¼Œä¾¿äºè¿›è¡Œå†…å­˜å›æ”¶ã€‚</li>
</ul>
<p>è¿™èƒŒååšäº†äº›ä»€ä¹ˆå·¥ä½œå‘¢ï¼Ÿæˆ‘ä»¬è·³è¿‡å»çœ‹çœ‹ã€‚</p>
<h3 id="memory-apiæ˜¯å¯¹jdkinternalmiscunsafeçš„å®‰å…¨å°è£…"><a class="markdownIt-Anchor" href="#memory-apiæ˜¯å¯¹jdkinternalmiscunsafeçš„å®‰å…¨å°è£…"></a> Memory APIæ˜¯å¯¹jdk.internal.misc.Unsafeçš„å®‰å…¨å°è£…</h3>
<p>æˆ‘ä»¬é¦–å…ˆè·³åˆ°<code>cString.getUtfString</code>ï¼Œå› ä¸ºå¾ˆæ˜æ˜¾è¯¥éƒ¨åˆ†æ¶‰åŠåˆ°è®¿é—®å †å¤–å†…å­˜çš„æ“ä½œã€‚å±€éƒ¨ä»£ç å¦‚ä¸‹ï¼š</p>
<p><code>MemorySegment.java line:1089</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> String <span class="title function_">getUtf8String</span><span class="params">(<span class="type">long</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SharedUtils.toJavaStringInternal(<span class="built_in">this</span>, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œå†™æŠŠæ“ä½œå†™åˆ°äº†ä¸€ä¸ªUtilé‡Œé¢ã€‚</li>
</ul>
<p>æˆ‘ä»¬è·³è¿‡å»çœ‹çœ‹ã€‚</p>
<hr />
<p><code>ShareUtils.java line:250</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toJavaStringInternal</span><span class="params">(MemorySegment segment, <span class="type">long</span> start)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> strlen(segment, start);</span><br><span class="line">    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line">    MemorySegment.copy(segment, JAVA_BYTE, start, bytes, <span class="number">0</span>, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ª<code>byte</code>æ•°ç»„ï¼Œè¿™æ˜¯åœ¨JVMæ ˆä¸Šçš„ï¼Œä¹‹åè®¿é—®å †å¤–å†…å­˜ï¼Œè¿›è¡Œcopyæ“ä½œã€‚</li>
</ul>
<p>å¾ˆæ˜æ˜¾<code>MemorySegment.copy</code>æ‰æ˜¯æˆ‘ä»¬å…³å¿ƒçš„ï¼Œå†è·³è¿‡å»çœ‹çœ‹ã€‚</p>
<hr />
<p><code>MemorySegment.java line:2209</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ForceInline</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(</span></span><br><span class="line"><span class="params">        MemorySegment srcSegment, ValueLayout srcLayout, <span class="type">long</span> srcOffset,</span></span><br><span class="line"><span class="params">        Object dstArray, <span class="type">int</span> dstIndex, <span class="type">int</span> elementCount)</span> &#123;</span><br><span class="line">    Objects.requireNonNull(srcSegment);</span><br><span class="line">    Objects.requireNonNull(dstArray);</span><br><span class="line">    Objects.requireNonNull(srcLayout);</span><br><span class="line"></span><br><span class="line">    AbstractMemorySegmentImpl.copy(srcSegment, srcLayout, srcOffset,</span><br><span class="line">            dstArray, dstIndex,</span><br><span class="line">            elementCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œå…ˆæ˜¯ä¸€é¡¿åˆ¤ç©ºï¼Œä¹‹åå†è°ƒç”¨äº†<code>AbstractMemorySegmentImpl.copy</code>æ–¹æ³•ï¼Œè¿™é‡Œ<code>AbstractMemorySegmentImpl</code>æ˜¯<code>MemorySegment</code>çš„å®ç°ï¼Œ<code>MemorySegment</code>æ˜¯ä¸€ä¸ªå¯†å°æ¥å£ï¼Œåªå…è®¸äº†<code>AbstractMemorySegmentImpl</code>å®ç°ã€‚</li>
</ul>
<p>OKï¼Œç»§ç»­è·³è½¬ã€‚</p>
<hr />
<p><code>AbstractMemorySegmentImpl.java line:625</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@ForceInline</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(MemorySegment srcSegment, ValueLayout srcLayout, <span class="type">long</span> srcOffset,</span></span><br><span class="line"><span class="params">                           Object dstArray, <span class="type">int</span> dstIndex,</span></span><br><span class="line"><span class="params">                           <span class="type">int</span> elementCount)</span> &#123;</span><br><span class="line"><span class="comment">// æ­¤å¤„çœç•¥äº†åŸæœ¬ä¸€ç³»åˆ—åˆ¤ç©ºã€æ ¡éªŒç­‰æ“ä½œã€‚</span></span><br><span class="line">       <span class="keyword">if</span> (dstWidth == <span class="number">1</span> || srcLayout.order() == ByteOrder.nativeOrder()) &#123;</span><br><span class="line">           ScopedMemoryAccess.getScopedMemoryAccess().copyMemory(srcImpl.sessionImpl(), <span class="literal">null</span>,</span><br><span class="line">                   srcImpl.unsafeGetBase(), srcImpl.unsafeGetOffset() + srcOffset,</span><br><span class="line">                   dstArray, dstBase + (dstIndex * dstWidth), elementCount * dstWidth);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ScopedMemoryAccess.getScopedMemoryAccess().copySwapMemory(srcImpl.sessionImpl(), <span class="literal">null</span>,</span><br><span class="line">                   srcImpl.unsafeGetBase(), srcImpl.unsafeGetOffset() + srcOffset,</span><br><span class="line">                   dstArray, dstBase + (dstIndex * dstWidth), elementCount * dstWidth, dstWidth);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>ScopedMemoryAccess</code>ï¼Œç†Ÿæ‚‰jdk.internal.misc.Unsafeçš„å¤§ä½¬ä¼°è®¡åˆ°è¿™å°±æ‡‚äº†ï¼Œ<code>ScopedMemoryAccess</code>ä¹Ÿæ˜¯åœ¨jdk.internal.miscä¸‹çš„ï¼Œå¹¶ä¸”å…¶ä¸­æœ‰ä¸€ä¸ª<code>UNSAFE</code>å­—æ®µã€‚</li>
</ul>
<p>æœ€ç»ˆï¼Œæˆ‘ä»¬é¡ºç€<code>ScopedMemoryAccess.getScopedMemoryAccess().copyMemory</code>æœ€ç»ˆä¼šè·³è½¬åˆ°å“ªé‡Œå‘¢ï¼Ÿç­”æ¡ˆæ˜¯<code>Unsafe</code>ä¸­çš„ä¸€ä¸ªnativeæ–¹æ³•ï¼š<code>copyMemory0</code>ï¼Œ<s>è€Œè¯¥nativeæ–¹æ³•æ˜¯é€šè¿‡JNIå®ç°çš„</s>è™½ç„¶å®ƒæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œä½†æ˜¯å®ƒè¢«<code>@IntrinsicCandidate</code>æ³¨è§£ä¿®é¥°ã€‚</p>
<h4 id="intrinsiccandidate"><a class="markdownIt-Anchor" href="#intrinsiccandidate"></a> @IntrinsicCandidate</h4>
<p>è¿™ä¸ªæ³¨è§£è¡¨æ˜è¢«ä¿®é¥°çš„æ–¹æ³•<strong>å¯èƒ½</strong>ä¼šè¢«HotSpotå†…è”ï¼Œè¿™å–å†³äºæ˜¯å¦ä¸ºå½“å‰å¹³å°çš„è™šæ‹Ÿæœºæ‰‹å†™äº†æ±‡ç¼–/ç¼–è¯‘å™¨IRï¼Œä»¥é™ä½å¼€é”€ã€‚</p>
<p>éƒ¨åˆ†jdk.internal.misc.Unsafeçš„nativeæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p><code>Unsafe.java line:3823</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">allocateMemory0</span><span class="params">(<span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">reallocateMemory0</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">freeMemory0</span><span class="params">(<span class="type">long</span> address)</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">setMemory0</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> bytes, <span class="type">byte</span> value)</span>;</span><br><span class="line"><span class="meta">@IntrinsicCandidate</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">copyMemory0</span><span class="params">(Object srcBase, <span class="type">long</span> srcOffset, Object destBase, <span class="type">long</span> destOffset, <span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">copySwapMemory0</span><span class="params">(Object srcBase, <span class="type">long</span> srcOffset, Object destBase, <span class="type">long</span> destOffset, <span class="type">long</span> bytes, <span class="type">long</span> elemSize)</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">objectFieldOffset0</span><span class="params">(Field f)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°åƒ<code>Unsafe::allocateMemory0</code>, <code>Unsafe::freeMemory0</code>ç­‰å…³é”®çš„nativeæ–¹æ³•æœªè¢«<code>@IntrinsicCandidate</code>æ³¨è§£ä¿®é¥°ï¼Œè¿™ä¹Ÿæ„å‘³ç€è¿™äº›æ–¹æ³•æ˜¯ä½¿ç”¨JNIå®ç°çš„ã€‚</li>
</ul>
<p>é‚£ä¹ˆMemory APIæ˜¯å¦ä½¿ç”¨äº†è¿™äº›nativeæ–¹æ³•å‘¢ï¼Ÿ</p>
<p>ç»è¿‡åˆ†æï¼ŒMemory APIå¼€è¾Ÿå †å¤–å†…å­˜çš„æ“ä½œç¡®å®ä½¿ç”¨äº†<code>Unsafe::allocateMemory0</code>æ–¹æ³•ã€‚</p>
<p>OKï¼Œå¯ä»¥ä¸‹ç»“è®ºäº†ï¼šMemory APIæ˜¯å¯¹<code>jdk.internal.misc.Unsafe</code>çš„å°è£…ï¼Œä½¿å¾—Javaç¨‹åºå‘˜æ“çºµå †å¤–å†…å­˜æ›´åŠ å¾—å¿ƒåº”æ‰‹ï¼Œè®©Unsafeå˜å¾—Safeã€‚è¿™ä¸€ç‚¹å…¶å®å·²åœ¨ç›¸å…³çš„JEPé‡Œè¡¨æ˜äº†ï¼š</p>
<blockquote>
<h2 id="non-goals"><a class="markdownIt-Anchor" href="#non-goals"></a> Non-goals</h2>
<p>It is not a goal to</p>
<p>Â· Re-implement JNI on top of this API, or otherwise change JNI in any way;</p>
<p>Â· Re-implement legacy Java APIs, such as <code>sun.misc.Unsafe</code>, on top of this API;</p>
<p>Â· Provide tooling that mechanically generates Java code from native-code header files; or</p>
<p>Â· Change how Java applications that interact with native libraries are packaged and deployed (e.g., via multi-platform JAR files).</p>
</blockquote>
<p><em>æ¥æºï¼š<a target="_blank" rel="noopener" href="https://openjdk.org/jeps/442">JEP 442: Foreign Function &amp; Memory API (Third Preview)</a></em></p>
<p>æˆ‘åœ¨é˜…è¯»è¯¥æ®µè½æ—¶é™·å…¥è¿‡ä¸€ä¸ªé€»è¾‘é”™è¯¯ï¼Œä¸ºé¿å…å¤§å®¶åŒæ ·é™·å…¥è¯¥é€»è¾‘é”™è¯¯ï¼Œæˆ‘åœ¨è¿™è§£é‡Šä¸€ä¸‹ã€‚</p>
<p>è¯¥æ®µç¬¬äºŒæ¡è®²çš„æ˜¯ï¼šåœ¨è¯¥APIä¸Šï¼Œé‡æ–°å®ç°åƒ<code>sun.misc.Unsafe</code>ä¹‹ç±»çš„é—ç•™APIã€‚è€Œè¿™é‡Œæ˜¯Non-goalsï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥APIä¸ä¼šé‡æ–°å®ç°åƒ<code>sun.misc.Unsafe</code>ä¹‹ç±»çš„é—ç•™APIï¼Œæ„å‘³ç€è¯¥APIä¼šåšä¸€äº›åƒå®Œå–„<code>sun.misc.Unsafe</code>ä¹‹ç±»çš„å·¥ä½œã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒJava FFM APIå¹¶æ²¡æœ‰å®Œå…¨è„±ç¦»JNIã€‚é‚£FFIéƒ¨åˆ†å‘¢ï¼Ÿè¯¥ä¸ä¼šä¹Ÿæ˜¯å°è£…JNIå§ï¼Ÿæˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<h2 id="foreign-function-interface"><a class="markdownIt-Anchor" href="#foreign-function-interface"></a> Foreign Function Interface</h2>
<p>æˆ‘åŒæ ·å†™äº†ä¸€ä¸ªDemoï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">downCallDemo</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">Linker</span> <span class="variable">linker</span> <span class="operator">=</span> Linker.nativeLinker();</span><br><span class="line">    <span class="type">MemorySegment</span> <span class="variable">strlen_address</span> <span class="operator">=</span> linker.defaultLookup().find(<span class="string">&quot;strlen&quot;</span>).get();</span><br><span class="line">    <span class="type">MethodHandle</span> <span class="variable">strlen</span> <span class="operator">=</span> linker.downcallHandle(</span><br><span class="line">            strlen_address,</span><br><span class="line">            FunctionDescriptor.of(JAVA_LONG, ADDRESS)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Arena</span> <span class="variable">arena</span> <span class="operator">=</span> Arena.ofConfined()) &#123;</span><br><span class="line">        <span class="type">MemorySegment</span> <span class="variable">cString</span> <span class="operator">=</span> arena.allocateUtf8String(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">len</span> <span class="operator">=</span> (<span class="type">long</span>) strlen.invokeExact(cString); <span class="comment">// 5</span></span><br><span class="line">        System.out.println(len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œå…ˆæ˜¯æ•´ä¸€ä¸ªLinkerï¼Œä¹‹åè·å–æœ¬åœ°æ—¢æœ‰å‡½æ•°<code>strlen</code>çš„åœ°å€ï¼Œæ¥ç€è°ƒç”¨å®ƒå¹¶ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæœ€åè·å–å®ƒçš„è¿”å›å€¼ï¼Œè¾“å‡ºã€‚</li>
</ul>
<p>æˆ‘æ¯”è¾ƒå¥½å¥‡çš„æ˜¯ï¼Œå®ƒæ˜¯å¦‚ä½•ç›´æ¥é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²æŸ¥æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°çš„ï¼Ÿ</p>
<h3 id="linker-ä¸-symbollookup"><a class="markdownIt-Anchor" href="#linker-ä¸-symbollookup"></a> Linker ä¸ SymbolLookup</h3>
<p>ä¸ºå¼„æ¸…ä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹<code>linker.defaultLookup()</code>æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå› ä¸ºå¾ˆæ˜æ˜¾è¿™é‡Œæ¶‰åŠåˆ°æŸ¥æ‰¾ç­‰æ“ä½œã€‚</p>
<p><code>Linker.java line:636</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SymbolLookup <span class="title function_">defaultLookup</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>é—æ†¾çš„æ˜¯ï¼Œ<code>Linker</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢å¹¶æ²¡æœ‰å®ç°<code>defaultLookup()</code>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒçš„å®ç°ç±»ã€‚</li>
</ul>
<p>åœ¨<code>Linker.java</code>ä¸­å¯ä»¥å‘ç°ï¼Œ<code>Linker</code>æ˜¯ä¸€ä¸ªå¯†å°æ¥å£ï¼Œä»…å…è®¸<code>AbstractLinker</code>å®ç°ã€‚</p>
<hr />
<p><code>AbstractLinker.java line:60</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title class_">AbstractLinker</span> <span class="keyword">implements</span> <span class="title class_">Linker</span> permits LinuxAArch64Linker, MacOsAArch64Linker,</span><br><span class="line">                                                                      SysVx64Linker, WindowsAArch64Linker,</span><br><span class="line">                                                                      Windowsx64Linker, LinuxPPC64leLinker,</span><br><span class="line">                                                                      LinuxRISCV64Linker, FallbackLinker &#123;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°ï¼Œ<code>AbstractLinker</code>æ˜¯ä¸ªå¯†å°ç±»ï¼Œå¹¶æä¾›äº†å¤šä¸ªå¹³å°çš„å®ç°ã€‚è¿™é‡Œä¾¿å¯ä»¥æ¨æ–­å‡ºï¼Œåœ¨æŸä¸ªåœ°æ–¹å­˜åœ¨æ ¹æ®å¹³å°è¿”å›ä¸åŒ<code>Linker</code>çš„æ“ä½œã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ“ä½œå°±åœ¨<code>Linker.nativeLinker()</code> ğŸ˜¦</li>
</ul>
<hr />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`AbstractLinker.java line:133`</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">    @Override</span><br><span class="line">    public SystemLookup defaultLookup() &#123;</span><br><span class="line">        return SystemLookup.getInstance();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œæ˜¯çš„è¿”å›ç±»å‹æ˜¯<code>SystemLookup</code>ï¼Œè€Œåœ¨<code>Linker</code>å†…ï¼Œ<code>defaultLookup</code>çš„è¿”å›ç±»å‹ä¸º<code>SymbolLookup</code>ã€‚å®é™…ä¸Šï¼Œ<code>SystemLookup</code>æ˜¯<code>SymbolLookup</code>çš„å®ç°ã€‚</li>
</ul>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­ï¼Œåœ¨æˆ‘ä»¬çš„Demoä¸­ï¼Œ<code>linker</code>ä¸ºå¯¹åº”å¹³å°çš„<code>Linker</code>å®ç°ï¼›<code>linker.defaultLookup()</code>å®é™…è¿”å›ä¸€ä¸ªSystemLookupå¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆï¼Œåœ¨<code>linker.defaultLookup().find(&quot;strlen&quot;)</code>ä¸­åˆå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<hr />
<p><code>SystemLookup.java line:137</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Optional&lt;MemorySegment&gt; <span class="title function_">find</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SYSTEM_LOOKUP.find(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SystemLookup.java line:57</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SymbolLookup</span> <span class="variable">SYSTEM_LOOKUP</span> <span class="operator">=</span> makeSystemLookup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SymbolLookup <span class="title function_">makeSystemLookup</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Utils.IS_WINDOWS) &#123;</span><br><span class="line">            <span class="keyword">return</span> makeWindowsLookup();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> libLookup(libs -&gt; libs.load(jdkLibraryPath(<span class="string">&quot;syslookup&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="comment">// This can happen in the event of a library loading failure - e.g. if one of the libraries the</span></span><br><span class="line">        <span class="comment">// system lookup depends on cannot be loaded for some reason. In such extreme cases, rather than</span></span><br><span class="line">        <span class="comment">// fail, return a dummy lookup.</span></span><br><span class="line">        <span class="keyword">return</span> FALLBACK_LOOKUP;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SystemLookup.java line:106</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SymbolLookup <span class="title function_">libLookup</span><span class="params">(Function&lt;RawNativeLibraries, NativeLibrary&gt; loader)</span> &#123;</span><br><span class="line">    <span class="type">NativeLibrary</span> <span class="variable">lib</span> <span class="operator">=</span> loader.apply(RawNativeLibraries.newInstance(MethodHandles.lookup()));</span><br><span class="line">    <span class="keyword">return</span> name -&gt; &#123;</span><br><span class="line">        Objects.requireNonNull(name);</span><br><span class="line">        <span class="keyword">if</span> (Utils.containsNullChars(name)) <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">addr</span> <span class="operator">=</span> lib.lookup(name);</span><br><span class="line">            <span class="keyword">return</span> addr == <span class="number">0</span> ?</span><br><span class="line">                    Optional.empty() :</span><br><span class="line">                    Optional.of(MemorySegment.ofAddress(addr));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸éš¾å‘ç°ï¼ŒDemoä¸­è°ƒç”¨<code>linker.defaultLookup().find(&quot;strlen&quot;)</code>æ—¶ï¼Œå®é™…è¿”å›ä¸€ä¸ªç±»å‹ä¸º<code>Optional&lt;MemorySegment&gt;</code>çš„å¯¹è±¡ã€‚</li>
<li>åœ¨<code>SystemLookup.libLookup()</code>ä¸­ï¼Œè¿›è¡Œäº†åŠ è½½æœ¬åœ°åº“ï¼Œè·å–å‡½æ•°åœ°å€ç­‰æ“ä½œã€‚æˆ‘ä»¬éœ€è¦ç ”ç©¶çš„ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•å†…ã€‚</li>
</ul>
<h3 id="jdkinternalloaderä¸‹çš„æœ¬åœ°åº“ç›¸å…³å®ä¾‹"><a class="markdownIt-Anchor" href="#jdkinternalloaderä¸‹çš„æœ¬åœ°åº“ç›¸å…³å®ä¾‹"></a> jdk.internal.loaderä¸‹çš„æœ¬åœ°åº“ç›¸å…³å®ä¾‹</h3>
<p>åœ¨ä»¥ä¸Šä»£ç ç‰‡æ®µä¸­ï¼Œ<code>NativeLibrary</code>ç”¨äºè¡¨ç¤ºå·²åŠ è½½çš„æœ¬åœ°åº“ã€‚å®˜æ–¹ç»™çš„è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>NativeLibrary represents a loaded native library instance.</p>
</blockquote>
<p>åœ¨ä»¥ä¸Šä»£ç ç‰‡æ®µä¸­ï¼Œ<code>RawNativeLibraries</code>ç”¨äºç®¡ç†å·²åŠ è½½çš„æœ¬åœ°åº“ã€‚å®ƒæœ‰ä¸€ä¸ª<code>libraries</code>å“ˆå¸Œè¡¨ï¼Œæ˜¾ç„¶æ˜¯ç”¨äºå­˜æ”¾å·²åŠ è½½çš„æœ¬åœ°åº“ï¼›æä¾›äº†<code>load</code>ï¼Œ<code>unload</code>ç­‰æ–¹æ³•çš„å®ç°ã€‚</p>
<p>æ³¨æ„ï¼Œä½¿ç”¨<code>RawNativeLibraries::load</code>æ–¹æ³•åŠ è½½çš„æœ¬åœ°åº“ï¼Œä¸ä¼šè¢«è§†ä¸ºJNIæœ¬åœ°åº“ï¼Œè€Œæ˜¯è¢«å½“æˆä¸€ä¸ªæ™®é€šçš„æœ¬åœ°åº“å¯¹å¾…ã€‚<code>RawNativeLIbraries</code>å¯ä»¥åŠ è½½JNIæœ¬åœ°åº“ï¼Œä½†æ˜¯JNIæœ¬åœ°åº“ä¸­ï¼ŒåŒ…å«<code>JNI_OnLoad</code>å’Œ<code>JNI_OnUnload </code>å‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¼šè¢«<code>RawNativeLIbraries</code>å¿½ç•¥ï¼Œå¯èƒ½å¯¼è‡´æ— æ³•ç»´æŒåŸJNIåº“çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¸æ”¯æŒå°†JNIæœ¬åœ°åº“ä¸­çš„å‡½æ•°å’Œnativeæ–¹æ³•é“¾æ¥ã€‚å®˜æ–¹è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>RawNativeLibraries has the following properties: 1. Native libraries loaded in this RawNativeLibraries instance are not JNI native libraries. Hence JNI_OnLoad and JNI_OnUnload will be ignored. No support for linking of native method. 2. Native libraries not auto-unloaded. They may be explicitly unloaded via NativeLibraries::unload. 3. No relationship with class loaders</p>
</blockquote>
<p>åŒæ—¶ï¼Œè¿™é‡Œå­˜åœ¨å¦å¤–çš„ç±»ç”¨äºåŠ è½½JNIæœ¬åœ°åº“ï¼š<code>NativeLibraries</code>ã€‚</p>
<p>ä»è¿™æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼ŒProject Panamaå°†FFIä¸JNIåšäº†ä¸¥æ ¼çš„åˆ‡å‰²ã€‚ä¸»è¦åŸå› æœ‰è¿™å‡ ç‚¹ï¼š</p>
<ol>
<li>FFIé»˜è®¤éœ€è¦åŠ è½½çš„æœ¬åœ°åº“ä¸æ˜¯ä¸“é—¨ä¸ºJVMè®¾è®¡çš„ã€‚</li>
<li>FFIè¦æ”¯æŒæœ¬åœ°åº“å¯ä»¥è¢«ä¸åŒçš„ClassloaderåŠ è½½ã€‚</li>
<li>FFIè¦æ”¯æŒæœ¬åœ°åº“å¯ä»¥æ ¹æ®éœ€è¦è¢«å¤šæ¬¡åŠ è½½ã€‚</li>
</ol>
<blockquote>
<p>è¿™ä¹Ÿæ˜¯FFIä¸JNIé‡è¦çš„ä¸åŒä¹‹å¤„ï¼ŒFFIèµ¢å¤ªå¤šäº†ã€‚</p>
</blockquote>
<p>åœ¨ä»¥ä¸Šä»£ç ç‰‡æ®µä¸­ï¼Œä¸éš¾å‘ç°ï¼Œæœ¬åœ°å‡½æ•°çš„åœ°å€ç”±<code>NativeLibrary::lookup()</code>å¾—åˆ°ã€‚</p>
<p>å®é™…ä¸Šï¼Œåœ¨ä»£ç ç‰‡æ®µ<code>SystemLookup.java line:106</code>ä¸­ï¼Œ<code>lib</code>çš„ç±»å‹æœ€ç»ˆä¸º<code>RawNativeLibraryImpl</code>ã€‚è¯¥ç±»ä¸º<code>RawNativeLibraries</code>çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿<code>NativeLibrary</code>ã€‚è€Œ<code>RawNativeLibraries::load</code>çš„è¿”å›å€¼ç±»å‹å°±æ˜¯<code>RawNativeLibraryImpl</code>ï¼Œå› æ­¤æœ¬åœ°å‡½æ•°çš„åœ°å€ç”±<code>RawNativeLibraryImpl::lookup()</code>å¾—åˆ°ã€‚</p>
<p>ä½†å®ƒå¹¶æ²¡æœ‰é‡å†™<code>lookup()</code>æ–¹æ³•ï¼Œå“ˆå“ˆï¼è€Œæ˜¯é‡å†™äº†<code>find()</code>æ–¹æ³•ï¼š</p>
<p><code>RawNativeLibraries.java line:168</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">find</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> findEntry0(handle, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>NativeLibrary.java line:48</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">lookup</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">addr</span> <span class="operator">=</span> find(name);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == addr) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Cannot find symbol &quot;</span> + name + <span class="string">&quot; in library &quot;</span> + name());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Returns the address of the named symbol defined in the library of</span></span><br><span class="line"><span class="comment"> * the given handle.  Returns 0 if not found.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">findEntry0</span><span class="params">(<span class="type">long</span> handle, String name)</span>;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»åˆ°è¾¾äº†Javaå®‡å®™çš„è¾¹ç•Œã€‚æ˜¾ç„¶ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨åˆ°äº†JNIï¼Œæ¥æŸ¥æ‰¾æœ¬åœ°å‡½æ•°çš„åœ°å€ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>é€šè¿‡è¿™æ¬¡åˆ†æå¯ä»¥çœ‹åˆ°ï¼ŒFFM APIåœ¨æ¶æ„ä¸Šåšå‡ºäº†å¾ˆå¤§çš„ä¼˜åŒ–ï¼Œè¿™ä¸€ç‚¹æˆ–è®¸å¯ä»¥è¯´æ˜FFM APIçš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p>
<p>FFIåœ¨åŠ è½½æœºåˆ¶ä¸Šåšå‡ºäº†å¾ˆå¤§æ”¹å˜ï¼Œå¤§å¤§æé«˜äº†äº’æ“ä½œæ€§ã€‚</p>
<p>FFM APIå¹¶æ²¡æœ‰ç‹¬ç«‹äºjdk.internal.misc.Unsafeå’ŒJNIå­˜åœ¨ï¼Œä½†ä¹Ÿä¸æ˜¯ç®€å•çš„å°è£…ï¼Œæ›´ä¸æ˜¯å¯¹JNIçš„ä¿®æ”¹ï¼Œè€Œæ˜¯ä¸€ç§åˆ©ç”¨å…³ç³»ã€‚</p>
<p>é—æ†¾çš„æ˜¯ï¼Œè¿™ç¯‡æ–‡ç« å¹¶æ²¡æœ‰æ¶‰åŠåˆ°<code>MethodHandle</code>ç›¸å…³çš„åˆ†æï¼Œæ²¡æœ‰è®²Java FFIæ˜¯å¦‚ä½•å®ç°<code>downcall</code>å’Œ<code>upcall</code>çš„ï¼Œå…¶ä¸­è¿˜æœ‰å¾ˆå¤šæœ‰è¶£çš„æŠ€æœ¯å’Œè§£å†³æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://openjdk.org/jeps/8310626">JEP draft: Foreign Function &amp; Memory API (openjdk.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://openjdk.org/projects/jdk/21/">JDK 21 (openjdk.org)</a></p>
</blockquote>

    </div>

    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            
            <p>This post is written by makai410, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="makai410/glut410.github.io" data-repo-id="R_kgDOH2uxDA" data-category="Announcements" data-category-id="DIC_kwDOH2uxDM4CQ9qo" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark" data-lang="en" crossorigin="anonymous" async> </script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/projects" class="item">Projects</a>
                
                <a href="/about" class="item">About</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Projects</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/makai410/cotack" class="item">cotack</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/makai410/vscode-helang" class="item">vscode-helang</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/makai410" class="item">GitHub</a>
                
                <a href="mailto:glut410@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 makai410<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>